–î–∞, **–æ—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º—ã—Å–ª—å** üëç
–¢–∞–∫–æ–π ‚Äú–ø—Ä–æ–ª–æ–≥‚Äù —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω ‚Äî –æ–Ω —Ä–µ–∑–∫–æ –ø–æ–≤—ã—à–∞–µ—Ç —à–∞–Ω—Å, —á—Ç–æ Codex **–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –¢–ó**, –∞ –Ω–µ –Ω–∞—á–Ω—ë—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ —Ç—É–¥–∞ –∏–ª–∏ —É–ø—Ä–æ—â–∞—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.

–ù–∏–∂–µ ‚Äî **–≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–ª–æ–≥**, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å **–ø–µ—Ä–µ–¥ –¢–ó**, –∫–∞–∫ `INTRODUCTION.md` –∏–ª–∏ –≤–µ—Ä—Ö–Ω–∏–π —Ä–∞–∑–¥–µ–ª `SPEC.md`.

---

# –ü—Ä–æ–ª–æ–≥ / –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ RTP Cleaner

## –ó–∞—á–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç ‚Äî **proof-of-concept (POC)** —Å–µ—Ä–≤–∏—Å–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∏–Ω–∏—Ç **–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π RTP –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ (H264)** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

–ò—Å—Ç–æ—á–Ω–∏–∫ –ø–æ—Ç–æ–∫–∞ ‚Äî **–¥–æ–º–æ—Ñ–æ–Ω**, –∫–æ—Ç–æ—Ä—ã–π:

* —à–ª—ë—Ç H264 over RTP,
* **–Ω–∞—Ä—É—à–∞–µ—Ç RFC 6184**,
* –∏–∑-–∑–∞ —á–µ–≥–æ **WebRTC –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç RTP, –Ω–æ –¥—Ä–æ–ø–∞—é—Ç –≤–∏–¥–µ–æ**.

–ü—Ä–æ–µ–∫—Ç **–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω-—Ä–µ—à–µ–Ω–∏–µ–º**, –µ–≥–æ —Ü–µ–ª—å:

* –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –ø–æ—Ç–æ–∫ –º–æ–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å ‚Äú–Ω–∞ –ª–µ—Ç—É‚Äù,
* –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é SIP/WebRTC –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É **–±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è rtpengine –∏–ª–∏ Kamailio**.

---

## –ì–¥–µ —Å–µ—Ä–≤–∏—Å —Å—Ç–æ–∏—Ç –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ

–¢–∏–ø–∏—á–Ω—ã–π –≤—ã–∑–æ–≤:

```
Doorphone ‚áÑ Kamailio ‚áÑ RTP-cleaner ‚áÑ rtpengine ‚áÑ WebRTC client
```

* RTP-cleaner –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –¥–æ–º–æ—Ñ–æ–Ω–æ–º –∏ rtpengine**
* WebRTC –∫–ª–∏–µ–Ω—Ç **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å RTP-cleaner –Ω–∞–ø—Ä—è–º—É—é**
* RTP-cleaner –Ω–µ –∑–Ω–∞–µ—Ç –Ω–∏—á–µ–≥–æ –æ SIP, SDP –∏–ª–∏ WebRTC –ª–æ–≥–∏–∫–µ ‚Äî —Ç–æ–ª—å–∫–æ RTP

---

## –í —á—ë–º –∏–º–µ–Ω–Ω–æ –±—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ RTP

–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–º–ø–æ–≤ (pcap) –≤—ã—è—Å–Ω–∏–ª–æ—Å—å:

### 1) Marker bit

* marker (`M=1`) –≤—ã—Å—Ç–∞–≤–ª—è–ª—Å—è:

  * –Ω–∞ SPS/PPS,
  * –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –∫–∞–¥—Ä–∞,
  * –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –æ–¥–Ω–æ–º access unit
* WebRTC **—Å—Ç—Ä–æ–≥–æ –æ–∂–∏–¥–∞–µ—Ç marker —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º RTP –ø–∞–∫–µ—Ç–µ –∫–∞–¥—Ä–∞**

### 2) Timestamp

* –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ RTP timestamps –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å:

  * –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤,
  * –¥–ª—è SPS/PPS –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ non-IDR –∫–∞–¥—Ä–∞
* —ç—Ç–æ **–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è WebRTC** –∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ drop‚Äô—É –∫–∞–¥—Ä–æ–≤

### 3) SPS/PPS –∏ IDR

* SPS/PPS –º–æ–≥–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å:

  * ‚Äú–º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏‚Äù,
  * —Å timestamp –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–∞–¥—Ä–∞
* WebRTC –Ω–µ –º–æ–∂–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–∫–∏–µ SPS/PPS —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º IDR –∏ **–Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ**

---

## –ö–∞–∫ –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –∏ –¥–æ–∫–∞–∑–∞–Ω–∞

–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–¥—Ö–æ–¥:

1. –ò–∑ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ pcap –±—ã–ª –∏–∑–≤–ª–µ—á—ë–Ω H264 elementary stream
2. –≠—Ç–æ—Ç –ø–æ—Ç–æ–∫ –±—ã–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ RTP —á–µ—Ä–µ–∑ ffmpeg
3. –ù–æ–≤—ã–π pcap –ø–æ–∫–∞–∑–∞–ª:

   * –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ marker
   * –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ timestamp
4. –¢–∞–∫–æ–π RTP **—É—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–ª—Å—è WebRTC –∫–ª–∏–µ–Ω—Ç–æ–º**

–î–∞–ª–µ–µ –±—ã–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ CLI-—É—Ç–∏–ª–∏—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è:

* —á–∏—Ç–∞–ª–∞ pcap,
* —á–∏–Ω–∏–ª–∞ marker/timestamp/SPS-PPS,
* –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ ‚Äú–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π‚Äù pcap,
* –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–ª–∞, —á—Ç–æ WebRTC –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ.

Live-—Å–µ—Ä–≤–∏—Å —è–≤–ª—è–µ—Ç—Å—è **–ø—Ä—è–º—ã–º —Ä–∞–∑–≤–∏—Ç–∏–µ–º —ç—Ç–æ–π –æ—Ñ—Ñ–ª–∞–π–Ω –ª–æ–≥–∏–∫–∏**.

---

## –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–µ–ª–∞–µ—Ç RTP-cleaner

RTP-cleaner **–Ω–µ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ** –∏ **–Ω–µ –º–µ–Ω—è–µ—Ç –∫–æ–¥–µ–∫**.

–û–Ω –¥–µ–ª–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–µ–µ:

* —Å–æ–±–∏—Ä–∞–µ—Ç RTP –ø–∞–∫–µ—Ç—ã –≤ **access unit (–∫–∞–¥—Ä)**,
* –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç:

  * `marker=1` —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–∞–∫–µ—Ç–µ –∫–∞–¥—Ä–∞,
  * –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π timestamp –Ω–∞ –≤—Å–µ –ø–∞–∫–µ—Ç—ã –∫–∞–¥—Ä–∞,
* –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç timestamps **–ø–æ wallclock**,
* –±—É—Ñ–µ—Ä–∏–∑—É–µ—Ç SPS/PPS –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –∫–∞–¥—Ä—É,
* –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ **–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**.

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –¥–æ–ø—É—â–µ–Ω–∏—è (–≤–∞–∂–Ω–æ)

* –≠—Ç–æ **POC**, –Ω–µ production
* RTCP **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** (–¥–æ–º–æ—Ñ–æ–Ω –µ–≥–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
* 1 UDP –ø–æ—Ä—Ç –Ω–∞ –ø–æ—Ç–æ–∫ (RTP only)
* –ù–µ–±–æ–ª—å—à–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞ (–¥–æ ~150 ms)
* Sequence numbers –≤ –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ **–Ω–µ –ø–µ—Ä–µ–Ω—É–º–µ—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è**
* –í–∏–¥–µ–æ —Ñ–∏–∫—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–º–æ—Ñ–æ–Ω ‚Üí rtpengine**

---

## –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è ‚Äú–ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å RTP‚Äù

–î–∞–∂–µ –µ—Å–ª–∏ RTP –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ Kamailio/rtpengine:

* WebRTC **–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞–∫–µ—Ç—ã**, –Ω–æ:

  * –Ω–µ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç,
  * —Å—á–∏—Ç–∞–µ—Ç –ø–æ—Ç–æ–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º,
  * silently drop‚Äô–∞–µ—Ç –∫–∞–¥—Ä—ã

RTP-cleaner –Ω—É–∂–µ–Ω –∏–º–µ–Ω–Ω–æ –∫–∞–∫ **–º–µ–¥–∏–∞–ø—Ä–æ—Å–ª–æ–π–∫–∞**, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–≤–æ–¥–∏—Ç RTP –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø—Ä–∏–µ–º–ª–µ–º–æ–µ –¥–ª—è WebRTC.

---

## –ß—Ç–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–¶–µ–ª—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî **–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤ live-—Ä–µ–∂–∏–º–µ** —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –¥–æ–∫–∞–∑–∞–ª–∞ —Å–≤–æ—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞ pcap:

* –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä (1 –∫–∞–¥—Ä),
* –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞,
* –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ RTP semantics –¥–ª—è H264.

---

## –ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å (–µ—Å–ª–∏ —á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–±–∑–∞—Ü)

> RTP-cleaner ‚Äî —ç—Ç–æ –Ω–µ ‚Äú–µ—â—ë –æ–¥–∏–Ω RTP proxy‚Äù.
> –≠—Ç–æ **H264-aware RTP normalizer**, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏ –¥–æ–º–æ—Ñ–æ–Ω–∞, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä—ã—Ö WebRTC –Ω–µ –º–æ–∂–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –º–æ–≥—É:

* —Å—Ä–∞–∑—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å **`architecture.md` —Å –¥–∏–∞–≥—Ä–∞–º–º–æ–π A/B –Ω–æ–≥**,
* –∏–ª–∏ **—Å–∫–µ–ª–µ—Ç –∫–æ–¥–∞** (–±–µ–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏), —á—Ç–æ–±—ã Codex –Ω–∞—á–∞–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
